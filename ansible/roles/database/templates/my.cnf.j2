# MariaDB database server configuration file.
[client]
port		= 3306
socket		= {{ database_unix_socket }}
default-character-set = utf8mb4

[mysqld_safe]
socket		= {{ database_unix_socket }}
nice		= 0

[mysqld]
user		= mysql
port		= 3306
skip-name-resolve=1
skip-external-locking=1

{% if database_role == 'main' %}
bind-address    = {{ database_bind_address }}
{% else %}
bind-address    = 127.0.0.1
{% endif %}

socket		= {{ database_unix_socket }}

pid-file	= /var/run/mysqld/mysqld.pid
basedir		= /usr
datadir		= {{ database_datadir }}
tmpdir		= /tmp

lc_messages_dir	= /usr/share/mysql
lc_messages	= en_US


#
# * Character sets
#
collation-server = utf8mb4_unicode_ci
character-set-server = utf8mb4

#
# * Fine Tuning
#
max_connections		= 50
connect_timeout		= 5
wait_timeout		= 600
max_allowed_packet	= 64M
thread_cache_size       = 128

innodb_flush_method = O_DIRECT

# Buffer Settings
bulk_insert_buffer_size	 = 16M
read_buffer_size         = 2M
join_buffer_size         = 2M
sort_buffer_size         = 2M

{% if database_role == 'main' %}
performance_schema=ON
key_buffer_size=64M
innodb_buffer_pool_size = 8G
innodb_log_file_size    = 2G
innodb_log_buffer_size  = 64M
tmp_table_size		= 64M
max_heap_table_size	= 64M
innodb_read_io_threads = 16
innodb_write_io_threads = 16
{% else %}
innodb_buffer_pool_size = 4G
innodb_log_file_size    = 1G
tmp_table_size		= 32M
max_heap_table_size	= 32M
innodb_read_io_threads = 8
innodb_write_io_threads = 8
{% endif %}

# innodb_buffer_pool_size = {{ innodb_buffer_pool_size }}

#
# * Query Cache Configuration

{% if database_role == 'main' %}
query_cache_limit		= 12M
query_cache_size		= 512M
{% else %}
query_cache_limit		= 6M
query_cache_size		= 256M
{% endif %}

query_cache_type		= ON


# * Logging and Replication
## Both location gets rotated by the cronjob.
# Be aware that this log type is a performance killer.
# As of 5.1 you can enable the log at runtime!
#general_log_file        = /var/log/mysql/mysql.log
#general_log             = 1
log_warnings		= 2

# Enable the slow query log to see queries with especially long duration
slow_query_log          = 1
slow_query_log_file	= /var/log/mysql/mariadb-slow.log
long_query_time         = 10
#log_slow_rate_limit	= 1000
log_slow_verbosity	= query_plan

log-queries-not-using-indexes
#log_slow_admin_statements

expire_logs_days	= 7
max_binlog_size         = 2G

{% if database_role == 'main' %}
server-id		= 1
log-basename            = main1
log_bin			= /var/log/mysql/mariadb-bin
log_bin_index		= /var/log/mysql/mariadb-bin.index
{% endif %}

{% if database_role == 'replicant' %}
server-id		= 2
log-basename            = replicant2
relay_log		= /var/log/mysql/relay-bin
relay_log_index	        = /var/log/mysql/relay-bin.index
relay_log_info_file	= /var/log/mysql/relay-bin.info
#log_slave_updates
read_only
{% endif %}

#auto_increment_increment = 2
#auto_increment_offset	= 1
# not fab for performance, but safer
#sync_binlog		= 1

default_storage_engine	= InnoDB

# ssl-ca=/etc/mysql/cacert.pem
# ssl-cert=/etc/mysql/server-cert.pem
# ssl-key=/etc/mysql/server-key.pem

[mysqldump]
quick
quote-names
max_allowed_packet	= 16M
